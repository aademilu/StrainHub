NJ_build_collapse <- function(filePath, accession, bootstrapValue) {
  dna <- read.dna(filePath, format="fasta")
  #create data frame in phangorn format
  aln_phyDat <- phyDat(dna, type="DNA", levels = NULL)
  
  mt <- modelTest(aln_phyDat)
  reducedmt <- mt[c(1,5),c(1,3)] #extracts rows 1 and 5 from modeltest, columns 1 and 3
  maxmt <- reducedmt[which.max(reducedmt$logLik),]
  dna_dist <- dist.ml(aln_phyDat, model=maxmt$Model)
  
  #Building NJ tree from distance matrix
  aln_NJ <- bionj(dna_dist)
  
  myBoots <- boot.phylo(aln_NJ, dna, function(e)
    root(nj(dist.dna(e, model=maxmt$Model)),accession)) #This roots on first sequence in alignment, can substitute with accession number
  myBoots
  
  plot(aln_NJ, show.tip=TRUE, edge.width=2)
  title("NJ + Bootstrap")
  nodelabels(myBoots, cex=.7)
  
  #collapse branches of poorly supported nodes into multifurcations with bootstrap values less than X%
  temp <- aln_NJ #Dont want to change chikv_NJ file itself, assign to new variable for safekeeping
  N <- length(aln_NJ$tip.label) #Get total number of taxa from tree
  toCollapse <- match(which(myBoots<bootstrapValue)+N, temp$edge[,2]) #match bootstrap value at node to 'destination' edge in second column, returns node number with bs <x%, to be collapsed
  temp$edge.length [toCollapse] <- 0 #Assigns 0 to edge lengths of nodes with bs <x%, collapses
  #di2multi collapse or resolve multichotomies in phylogenetic trees
  collapsedTree <- di2multi(temp, tol=.00001) #For branch to be considered separate, must be at least this length
  
  collapsedTree <- ladderize(collapsedTree)
  plot(collapsedTree, show.tip = TRUE, edge.width=1)
  title("NJ tree after collapsing weak bootstrap nodes")
  rootedTree <<- collapsedTree
}

NJ_build_collapse(filePath = "../data/chikv_westernafrica.aln.fasta", accession = "HM045815.1", bootstrapValue = 1)
